{% if signauxAnterieurs is not empty %}
    <div class="card mt-5 border-secondary">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">

                {% if typeSignal == 'signal' %}
                    {% set libelleCard = 'Autres signaux non-cloturés et non-prévus à cette date' %}
                    {% set libelleSignal = 'signal' %}
                {% elseif typeSignal == 'fait_marquant' %}
                    {% set libelleCard = 'Autres faits marquants non-cloturés et non-prévus à cette date' %}
                    {% set libelleSignal = 'fait marquant' %}
                {% endif %}

                <i class="bi bi-archive me-2"></i>{{ libelleCard }}
            </h5>
            <span class="badge bg-light text-dark">{{ signauxAnterieurs|length }}</span>
        </div>
        <div class="card-body card-sig-non-lie-bg">
            {% for signalAnterieur in signauxAnterieurs %}
                {% set status = get_signal_status(signalAnterieur) %}
                {% set badge_class = 'secondary' %}
                {% if status == 'presente' %}
                    {% set badge_class = 'success' %}
                {% elseif status == 'prevu' or status == 'en_cours_de_creation' %}
                    {% set badge_class = 'info' %}
                {% elseif status == 'en_cours' %}
                    {% set badge_class = 'primary' %}
                {% elseif status == 'cloture' %}
                    {% set badge_class = 'dark' %}
                {% endif %}

                <div class="card mb-3 shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <a href="{{ path('app_signal_modif', {'signalId': signalAnterieur.id, 
                                                                'routeSource': 'app_reunion_signal_detail', 
                                                                'reuSiId': reunionSignal.id, 
                                                                'tab': currentTab }) }}" class="text-decoration-none text-dark">
                                Signal n°{{ signalAnterieur.id }} : {{ signalAnterieur.Titre }}
                            </a>
                        </h6>
                        <div>
                            <span class="badge bg-{{ badge_class }} me-2">{{ status|humanize_status }}</span>
                            <a href="{{ path('app_reunion_create_suivi', {'reunionId': reunionSignal.id, 
                                                                        'signalId': signalAnterieur.id, 
                                                                        'tab': currentTab}) }}" class="btn btn-sm btn-outline-primary" title="Ajouter ce signal à la réunion en cours">
                                <i class="bi bi-plus-circle"></i> Ajouter un suivi à la réunion du {{ reunionSignal.DateReunion|format_datetime('short', 'none', locale='fr') }}
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Description du {{ libelleSignal }}:</strong><br>
                            {{ signalAnterieur.DescriptionSignal|slice(0, 300) }}{% if signalAnterieur.DescriptionSignal|length > 300 %}...{% endif %}
                        </div>
                        
                        {% set latest_suivis = signalAnterieur.getSuivis()|sort((a, b) => b.numeroSuivi <=> a.numeroSuivi)|slice(0, 3) %}
                        {% if latest_suivis is not empty %}
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped table-hover table-sm small">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 15%;">Réunion (Suivi n°)</th>
                                            <th style="width: 30%;">Suivi</th>
                                            <th style="width: 30%;">Relevé de Décision</th>
                                            <th>Mesures</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for suivi in latest_suivis %}
                                            <tr>
                                                <td>
                                                    {{ suivi.reunionSignal ? suivi.reunionSignal.DateReunion|format_datetime('short', 'none', locale='fr') : 'N/A' }}<br>
                                                    <span class="fw-normal">(Suivi n°{{ suivi.NumeroSuivi }})</span>
                                                </td>
                                                <td>
                                                    {{ (suivi.DescriptionSuivi ? suivi.DescriptionSuivi|slice(0, 150) ~ '...' : '')|raw }}
                                                </td>
                                                <td>
                                                    {% if suivi.RddLie %}
                                                        {{ (suivi.RddLie.DescriptionRDD ? suivi.RddLie.DescriptionRDD|slice(0, 150) ~ '...' : '')|raw }}
                                                    {% else %}
                                                        <span class="text-muted fst-italic">N/A</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if suivi.RddLie and suivi.RddLie.getMesuresRDDs() is not empty %}
                                                        <ul class="list-unstyled mb-0">
                                                            {% for mesure in suivi.RddLie.getMesuresRDDs()|slice(0, 3) %}
                                                                <li class="mb-1">
                                                                    <i class="bi bi-check2-square me-1"></i>
                                                                    {{ mesure.LibMesure|slice(0, 100) }}...
                                                                    {% if mesure.DatePrevisionnelle %}
                                                                        <br><small class="text-muted">(prév. {{ mesure.DatePrevisionnelle|format_datetime('short', 'none', locale='fr') }})</small>
                                                                    {% endif %}
                                                                </li>
                                                            {% endfor %}
                                                        </ul>
                                                    {% else %}
                                                        <span class="text-muted fst-italic">Aucune mesure.</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted fst-italic">Aucun suivi pour ce signal.</p>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endif %}
