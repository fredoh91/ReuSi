{% extends 'base.html.twig' %}

{% set page_title = typeSignal == 'signal' ? 'Liste des signaux' : 'Liste des faits marquants' %}

{% block body_class %}
    {{ typeSignal == 'signal' ? 'page-signal' : 'page-fait-marquant' }}
{% endblock %}

{% block title %}{{ page_title }}{% endblock %}

{% block body %}



	{# Affichage des messages flash #}
    {% for type, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ type }}">{{ message }}</div>
        {% endfor %}
    {% endfor %}




<div class="container-fluid mt-4">
    <h1>{{ page_title }}</h1>

    <div class="card mb-4">
        <div class="card-header">
            <i class="bi bi-search"></i> Recherche
        </div>
        <div class="card-body">
            {{ form_start(searchForm) }}
                <div class="row g-3 align-items-end">
                    {# Ligne 1 #}
                    <div class="col-md-3">{{ form_row(searchForm.Titre) }}</div>
                    <div class="col-md-3">{{ form_row(searchForm.Indication) }}</div>
                    <div class="col-md-3">{{ form_row(searchForm.Contexte) }}</div>
                    <div class="col-md-3">{{ form_row(searchForm.Description) }}</div>

                    {# Ligne 2 #}
                    <div class="col-md-3">{{ form_row(searchForm.denomination) }}</div>
                    <div class="col-md-3">{{ form_row(searchForm.dci) }}</div>
                    <div class="col-md-3">{{ form_row(searchForm.dateReunionDebut) }}</div>
                    <div class="col-md-3">{{ form_row(searchForm.dateReunionFin) }}</div>
                </div>
                <div class="mt-3 d-flex justify-content-center gap-5">
                    {{ form_widget(searchForm.recherche) }}
                    {{ form_widget(searchForm.reset) }}
                    {{ form_widget(searchForm.annulation) }}
                </div>
            {{ form_end(searchForm) }}
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            {{ pagination.getTotalItemCount }} {{ typeSignal ~ (pagination.getTotalItemCount > 1 ? 's' : '') }} trouvé{{ pagination.getTotalItemCount > 1 ? 's' : '' }}
        </div>
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Titre</th>
                        <th>Description</th>
                        {# <th>Créé le</th>
                        <th>Modifié le</th> #}
                        <th>Statut</th>
                        <th>Suivis</th>
                        <th>Relevé de décision</th>
                    </tr>
                </thead>
                <tbody>
                    {% for signal in pagination %}
                        <tr>
                            <td>
                                {% set routeSource = typeSignal == 'signal' ? 'app_signal_liste' : 'app_fait_marquant_liste' %}
                                <a href="{{ path('app_signal_modif', {
                                    'signalId': signal.id, 
                                    'routeSource': routeSource
                                }) }}">
                                    {{ signal.id }}
                                </a>
                            </td>
                            <td>{{ signal.titre }}</td>
                            <td>
                                {{ signal.DescriptionSignal|slice(0, 500) }}{% if signal.DescriptionSignal|length > 500 %}...{% endif %}
                            </td>
                            {# <td>
                                {% if signal.createdAt != null %}
                                    {{ signal.createdAt|format_datetime(dateFormat='short', timeFormat='short', locale='fr') }}
                                {% else %}
                                    ---
                                {% endif %}
                            </td>
                            <td>
                                {% if signal.updatedAt != null %}
                                    {{ signal.updatedAt|format_datetime(dateFormat='short', timeFormat='short', locale='fr') }}
                                {% else %}
                                    ---
                                {% endif %}
                            </td> #}
                            <td>
                                {% set status = get_signal_status(signal) %}
                                {% set badge_class = 'secondary' %}
                                {% if status == 'presente' %}
                                    {% set badge_class = 'success' %}
                                {% elseif status == 'prevu' or status == 'en_cours_de_creation' %}
                                    {% set badge_class = 'info' %}
                                {% elseif status == 'en_cours' %}
                                    {% set badge_class = 'primary' %}
                                {% elseif status == 'cloture' %}
                                    {# On utilise 'dark' pour 'cloture' pour une meilleure visibilité que 'danger' qui est souvent rouge vif #}
                                    {% set badge_class = 'danger' %}
                                {% endif %}

                                <span class="badge bg-{{ badge_class }}">{{ status|humanize_status }}</span>
                                {# {% set statutActif = null %}
                                {% for statut in signal.statutSignals %}
                                    {% if statut.statutActif %}
                                        {% set statutActif = statut %}
                                    {% endif %}
                                {% endfor %}
                                {{ statutActif ? statutActif.libStatut : '---' }} #}


                            </td>
                            <td>
                                {% if signal.getSuivis() is not empty %}
                                    {% for suivi in signal.getSuivis() %}
                                        {% if suivi.DescriptionSuivi is not empty %}
                                            <ul>
                                                <li>
                                                    <a href="{{ path('app_modif_suivi', {'signalId': signal.id, 'suiviId': suivi.id, 'routeSource': 'app_signal_liste'}) }}">{{ suivi.NumeroSuivi }}</a> - 
                                                    {{ suivi.reunionSignal and suivi.reunionSignal.DateReunion ? suivi.reunionSignal.DateReunion|format_datetime(dateFormat='short', timeFormat='none', locale='fr') : 'Pas de date de réunion' }} - 
                                                    {{ suivi.DescriptionSuivi|slice(0, 300) }}{% if suivi.DescriptionSuivi|length > 300 %}...{% endif %}
                                                </li>
                                            </ul>
                                        {% else %}
                                            <ul>
                                                <li>
                                                    <a href="{{ path('app_modif_suivi', {'signalId': signal.id, 'suiviId': suivi.id, 'routeSource': 'app_signal_liste'}) }}">{{ suivi.NumeroSuivi }}</a> -
                                                    {{ suivi.reunionSignal and suivi.reunionSignal.DateReunion ? suivi.reunionSignal.DateReunion|format_datetime(dateFormat='short', timeFormat='none', locale='fr') : 'Pas de date de réunion' }} - 
                                                    Pas de description
                                                </li>
                                            </ul>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    Pas de suivi
                                {% endif %}
                            </td>
                            <td>
                                {% if signal.getReleveDeDecision() is not empty %}
                                    {% for rdd in signal.getReleveDeDecision() %}
                                        {% if rdd.DescriptionRDD is not empty %}
                                            <ul>
                                                <li>
                                                    {# {% if is_granted('ROLE_SUPER_ADMIN') %}
                                                        <a href="{{ path('app_modif_RDD', {'signalId': signal.id, 'rddId': rdd.id}) }}">{{ rdd.NumeroRDD }}</a> -
                                                    {% else %} #}
                                                        {# {{ rdd.NumeroRDD }} #}
                                                    {# {% endif %} #}
                                                    {# {{ rdd.reunionSignal and rdd.reunionSignal.DateReunion ? rdd.reunionSignal.DateReunion|format_datetime(dateFormat='short', timeFormat='none', locale='fr') : 'N/A' }} -  #}
                                                    {{ rdd.DescriptionRDD|slice(0, 300) }}{% if rdd.DescriptionRDD|length > 300 %}...{% endif %}
                                                </li>
                                            </ul>
                                        {% else %}
                                            <ul>
                                                <li>
                                                    {# <a href="{{ path('app_modif_RDD', {'signalId': signal.id, 'rddId': rdd.id}) }}">{{ rdd.NumeroRDD }}</a> - #}
                                                    {# {{ rdd.reunionSignal and rdd.reunionSignal.DateReunion ? rdd.reunionSignal.DateReunion|format_datetime(dateFormat='short', timeFormat='none', locale='fr') : 'N/A' }} -  #}
                                                    Pas de description
                                                </li>
                                            </ul>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    Pas de relevé de décision
                                {% endif %}
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center">Aucun signal trouvé pour vos critères.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="navigation d-flex justify-content-center">
                {{ knp_pagination_render(pagination) }}
            </div>
        </div>
    </div>
</div>
{% endblock %}